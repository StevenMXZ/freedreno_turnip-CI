name: Turnip Bisect (Pre-Unified Test)

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA (Padrão: Pre-Unified)'
        required: true
        default: '79656dbcd30'
        type: string

jobs:
  build-turnip:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necessário para criar a Release/Tag automaticamente

    steps:
      - name: Checkout Specific Commit
        uses: actions/checkout@v4
        with:
          repository: https://gitlab.freedesktop.org/mesa/mesa.git
          ref: ${{ inputs.commit_sha }}
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson ninja-build patchelf flex bison python3-mako python3-pip zip

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27 # Versão estável que suporta SDK 35

      - name: Create Crossfile (SDK 35)
        run: |
          echo "[binaries]" > android-cross.txt
          echo "c = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android35-clang'" >> android-cross.txt
          echo "cpp = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android35-clang++'" >> android-cross.txt
          echo "ar = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'" >> android-cross.txt
          echo "strip = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'" >> android-cross.txt
          echo "pkgconfig = '/usr/bin/pkg-config'" >> android-cross.txt
          echo "[host_machine]" >> android-cross.txt
          echo "system = 'android'" >> android-cross.txt
          echo "cpu_family = 'aarch64'" >> android-cross.txt
          echo "cpu = 'armv8'" >> android-cross.txt
          echo "endian = 'little'" >> android-cross.txt

      - name: Build Turnip (No Patches)
        run: |
          # SDK 35, Release, Sem Fix A6xx
          meson setup build \
            --cross-file android-cross.txt \
            -Dbuildtype=release \
            -Dplatforms=android \
            -Dplatform-sdk-version=35 \
            -Dandroid-stub=true \
            -Dgallium-drivers= \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Degl=disabled \
            -Dglx=disabled \
            -Dshared-glapi=enabled \
            -Dvulkan-beta=true \
            -Db_lto=true \
            -Ddefault_library=shared

          ninja -C build

      - name: Package Driver
        run: |
          mkdir -p package
          cp build/src/freedreno/vulkan/libvulkan_freedreno.so package/vulkan.ad07XX.so
          
          # Patch Soname
          patchelf --set-soname "vulkan.adreno.so" package/vulkan.ad07XX.so
          
          # Criar meta.json
          echo '{
            "schemaVersion": 1,
            "name": "Turnip-Test-${{ inputs.commit_sha }}",
            "description": "Bisect Test (Pre-Unified). Commit: ${{ inputs.commit_sha }}",
            "author": "CI",
            "libraryName": "vulkan.ad07XX.so"
          }' > package/meta.json

          cd package
          zip -9 ../Turnip-Test-${{ inputs.commit_sha }}.zip *

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: bisect-${{ inputs.commit_sha }} # Resolve o erro "requires a tag"
          name: Bisect Test - ${{ inputs.commit_sha }}
          body: |
            Build de teste de regressão.
            Commit: ${{ inputs.commit_sha }}
            SDK: 35
          files: Turnip-Test-${{ inputs.commit_sha }}.zip
          make_latest: false
