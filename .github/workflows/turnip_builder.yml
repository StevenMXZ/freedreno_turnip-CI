name: Build Turnip Revert (Unreal Fix)

on:
  workflow_dispatch:

jobs:
  build_turnip:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/ubuntu.sources
        sudo apt update
        sudo apt build-dep mesa -y
        sudo apt install -y ccache python3-pip patchelf zip unzip
        pip install meson ninja mako

    - name: Run Turnip Revert build
      run: bash ./turnip_builder.sh

    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          turnip_workdir/meson_log
          turnip_workdir/ninja_log

    - name: Upload driver
      uses: actions/upload-artifact@v4
      with:
        name: turnip-revert
        path: turnip_workdir/*.zip

    - name: Release to GitHub
      uses: softprops/action-gh-release@v1
      with:
        tag_name: Turnip-Revert
        name: Turnip Revert (Unreal Freeze Fix)
        body: |
          Automatic Mesa revert build between:
          - ✅ Good: 47619ef5
          - ❌ Bad: 93f24f0b
          Fixes periodic freezes on Unreal Engine titles.
        files: turnip_workdir/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
